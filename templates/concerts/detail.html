{% extends 'base.html' %}

{% block title %}{{ concert.title }} - {{ concert.date|date:"j F Y" }} - Polyphonica Recorder Trio{% endblock %}

{% block meta_description %}{{ concert.description|truncatewords:30|striptags }}{% endblock %}

{% block canonical %}<link rel="canonical" href="{{ request.scheme }}://{{ request.get_host }}{{ concert.get_absolute_url }}">{% endblock %}

{% block og_type %}event{% endblock %}
{% block og_title %}{{ concert.title }} - {{ concert.date|date:"j F Y" }}{% endblock %}
{% block og_description %}{{ concert.description|truncatewords:30|striptags }}{% endblock %}
{% block og_image %}{% if concert.image %}{{ request.scheme }}://{{ request.get_host }}{{ concert.image.url }}{% endif %}{% endblock %}
{% block og_extra %}
<meta property="og:url" content="{{ request.scheme }}://{{ request.get_host }}{{ concert.get_absolute_url }}">
{% endblock %}

{% block twitter_title %}{{ concert.title }} - {{ concert.date|date:"j F Y" }}{% endblock %}
{% block twitter_description %}{{ concert.description|truncatewords:30|striptags }}{% endblock %}
{% block twitter_image %}{% if concert.image %}{{ request.scheme }}://{{ request.get_host }}{{ concert.image.url }}{% endif %}{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "MusicEvent",
    "name": "{{ concert.title|escapejs }}",
    "description": "{{ concert.description|truncatewords:50|striptags|escapejs }}",
    "startDate": "{{ concert.date|date:'Y-m-d' }}T{{ concert.time|time:'H:i:s' }}",
    "eventStatus": "https://schema.org/EventScheduled",
    "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
    "location": {
        "@type": "Place",
        "name": "{{ concert.venue_name|escapejs }}",
        "address": {
            "@type": "PostalAddress",
            "streetAddress": "{{ concert.venue_address|escapejs }}",
            "postalCode": "{{ concert.venue_postcode|escapejs }}"
        }
    },
    "performer": {
        "@type": "PerformingGroup",
        "name": "Polyphonica Recorder Trio"
    },
    "organizer": {
        "@type": "PerformingGroup",
        "name": "Polyphonica Recorder Trio",
        "url": "https://polyphonicarecordertrio.com"
    }
    {% if concert.image %},
    "image": "{{ request.scheme }}://{{ request.get_host }}{{ concert.image.url }}"
    {% endif %}
    {% if concert.ticket_source == 'internal' and concert.full_price %},
    "offers": {
        "@type": "Offer",
        "price": "{{ concert.full_price }}",
        "priceCurrency": "GBP",
        "availability": "{% if concert.is_sold_out %}https://schema.org/SoldOut{% else %}https://schema.org/InStock{% endif %}",
        "url": "{{ request.scheme }}://{{ request.get_host }}{% url 'concerts:order_tickets' concert.slug %}"
    }
    {% endif %}
}
</script>
{% endblock %}

{% block content %}
<section class="py-16 px-4">
    <div class="max-w-4xl mx-auto">
        <!-- Breadcrumb -->
        <nav class="mb-8 text-sm">
            <a href="{% url 'concerts:index' %}" class="text-accent-600 hover:text-accent-700">Concerts</a>
            <span class="mx-2 text-primary-400">/</span>
            <span class="text-primary-600">{{ concert.title }}</span>
        </nav>

        <div class="grid md:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="md:col-span-2">
                {% if concert.image %}
                    <img src="{{ concert.image.url }}" alt="{{ concert.title }}" class="w-full h-64 md:h-80 object-cover rounded-xl mb-8">
                {% endif %}

                <h1 class="text-3xl md:text-4xl font-serif font-bold text-primary-900 mb-4">{{ concert.title }}</h1>

                <div class="prose prose-lg max-w-none text-primary-700 mb-8">
                    {{ concert.description|linebreaks }}
                </div>

            </div>

            <!-- Sidebar -->
            <div class="md:col-span-1">
                <div class="sticky top-24 bg-primary-50 rounded-xl p-6">
                    <!-- Date & Time -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-primary-900 mb-2">Date & Time</h3>
                        <p class="text-primary-700">
                            <span class="block text-lg font-medium">{{ concert.date|date:"l, j F Y" }}</span>
                            <span class="text-primary-600">{{ concert.time|time:"g:i A" }}</span>
                            {% if concert.doors_open %}
                                <span class="block text-sm text-primary-500">Doors open {{ concert.doors_open|time:"g:i A" }}</span>
                            {% endif %}
                        </p>
                    </div>

                    <!-- Venue -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-primary-900 mb-2">Venue</h3>
                        <p class="text-primary-700">
                            <span class="block font-medium">{{ concert.venue_name }}</span>
                            {% if concert.venue_address %}
                                <span class="block text-sm text-primary-600">{{ concert.venue_address }}</span>
                            {% endif %}
                            {% if concert.venue_postcode %}
                                <span class="block text-sm text-primary-600">{{ concert.venue_postcode }}</span>
                            {% endif %}
                        </p>
                        {% if concert.venue_map_link %}
                            <a href="{{ concert.venue_map_link }}" target="_blank" rel="noopener" class="inline-block mt-2 text-sm text-accent-600 hover:text-accent-700">
                                View on map →
                            </a>
                        {% endif %}
                    </div>

                    <!-- Tickets -->
                    <div class="border-t border-primary-200 pt-6">
                        <h3 class="font-semibold text-primary-900 mb-3">Tickets</h3>

                        {% if concert.is_past %}
                            <p class="text-primary-600">This concert has passed</p>

                        {% elif concert.ticket_source == 'internal' %}
                            <div class="mb-4">
                                <div class="flex justify-between mb-1">
                                    <span class="text-primary-700">Full price</span>
                                    <span class="font-semibold text-primary-900">£{{ concert.full_price }}</span>
                                </div>
                                {% if concert.discount_price %}
                                <div class="flex justify-between text-sm">
                                    <span class="text-primary-600">{{ concert.discount_label }}</span>
                                    <span class="text-primary-700">£{{ concert.discount_price }}</span>
                                </div>
                                {% endif %}
                            </div>

                            {% if concert.is_sold_out %}
                                <div class="w-full py-3 bg-primary-300 text-primary-600 text-center font-semibold rounded-lg">
                                    Sold Out
                                </div>
                            {% else %}
                                <a href="{% url 'concerts:order_tickets' concert.slug %}" class="block w-full py-3 bg-accent-500 hover:bg-accent-600 text-white text-center font-semibold rounded-lg transition-colors">
                                    Buy Tickets
                                </a>
                                {% if concert.tickets_remaining %}
                                    <p class="text-center text-sm text-primary-500 mt-2">{{ concert.tickets_remaining }} tickets remaining</p>
                                {% endif %}
                            {% endif %}

                        {% elif concert.ticket_source == 'external' %}
                            <p class="text-primary-600">Tickets available from external provider</p>
                            {% if concert.external_ticket_url %}
                                <a href="{{ concert.external_ticket_url }}" target="_blank" rel="noopener" class="inline-block mt-2 text-sm text-accent-600 hover:text-accent-700">
                                    Visit ticket provider →
                                </a>
                            {% endif %}

                        {% elif concert.ticket_source == 'door' %}
                            <p class="text-primary-600">Tickets available on the door</p>

                        {% else %}
                            <p class="text-primary-600">Free entry or by invitation</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
