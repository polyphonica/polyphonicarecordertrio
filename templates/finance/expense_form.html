{% extends 'staff/base.html' %}

{% block title %}{{ action }} Expense - Finance - Polyphonica{% endblock %}
{% block page_title %}{{ action }} Expense{% endblock %}
{% block page_subtitle %}{% if expense %}Editing: {{ expense.description }}{% else %}Add a new expense record{% endif %}{% endblock %}

{% block staff_content %}
<form method="post" enctype="multipart/form-data" class="max-w-2xl">
    {% csrf_token %}

    <!-- Error Handling -->
    {% if form.errors %}
    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
        <p class="font-medium mb-2">Please correct the errors below:</p>
        <ul class="list-disc list-inside">
            {% for field in form %}
                {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Basic Info -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-lg font-semibold text-primary-900 mb-4">Expense Details</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="id_category" class="block text-sm font-medium text-primary-700 mb-1">Category *</label>
                <select name="category" id="id_category" required
                        class="w-full px-4 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500">
                    {% for value, label in form.fields.category.choices %}
                    <option value="{{ value }}" {% if form.category.value == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="id_expense_date" class="block text-sm font-medium text-primary-700 mb-1">Date *</label>
                <input type="date" name="expense_date" id="id_expense_date"
                       value="{{ form.expense_date.value|date:'Y-m-d'|default:'' }}" required
                       class="w-full px-4 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500">
            </div>
        </div>

        <div class="mb-4">
            <label for="id_description" class="block text-sm font-medium text-primary-700 mb-1">Description *</label>
            <input type="text" name="description" id="id_description"
                   value="{{ form.description.value|default:'' }}" required maxlength="200"
                   placeholder="e.g., Village hall hire, Tea and biscuits"
                   class="w-full px-4 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500">
        </div>

        <div class="mb-4">
            <label for="id_amount" class="block text-sm font-medium text-primary-700 mb-1">Amount (&pound;) *</label>
            <input type="number" name="amount" id="id_amount" step="0.01" min="0"
                   value="{{ form.amount.value|default:'' }}" required
                   placeholder="0.00"
                   class="w-full px-4 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500">
        </div>

        <div>
            <label for="id_notes" class="block text-sm font-medium text-primary-700 mb-1">Notes</label>
            <textarea name="notes" id="id_notes" rows="3"
                      placeholder="Any additional details..."
                      class="w-full px-4 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500">{{ form.notes.value|default:'' }}</textarea>
        </div>
    </div>

    <!-- Link to Event -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-lg font-semibold text-primary-900 mb-4">Link to Event (Optional)</h2>
        <p class="text-sm text-primary-500 mb-4">Optionally link this expense to a specific workshop or concert. Leave both blank for general expenses.</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="id_workshop" class="block text-sm font-medium text-primary-700 mb-1">Workshop</label>
                <select name="workshop" id="id_workshop"
                        class="w-full px-4 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500">
                    <option value="">-- No workshop --</option>
                    {% for workshop in form.fields.workshop.queryset %}
                    <option value="{{ workshop.pk }}" {% if form.workshop.value|stringformat:"s" == workshop.pk|stringformat:"s" %}selected{% endif %}>
                        {{ workshop.title }} ({{ workshop.date|date:"j M Y" }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="id_concert" class="block text-sm font-medium text-primary-700 mb-1">Concert</label>
                <select name="concert" id="id_concert"
                        class="w-full px-4 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500">
                    <option value="">-- No concert --</option>
                    {% for concert in form.fields.concert.queryset %}
                    <option value="{{ concert.pk }}" {% if form.concert.value|stringformat:"s" == concert.pk|stringformat:"s" %}selected{% endif %}>
                        {{ concert.title }} ({{ concert.date|date:"j M Y" }})
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Receipt -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-lg font-semibold text-primary-900 mb-4">Receipt (Optional)</h2>

        {% if expense.receipt %}
        <div class="mb-4 p-4 bg-primary-50 rounded-lg">
            <p class="text-sm text-primary-700 mb-2">Current receipt:</p>
            <a href="{{ expense.receipt.url }}" target="_blank" class="text-accent-600 hover:text-accent-700">
                {{ expense.receipt.name }}
            </a>
        </div>
        {% endif %}

        <div>
            <label for="id_receipt" class="block text-sm font-medium text-primary-700 mb-1">
                {% if expense.receipt %}Replace receipt{% else %}Upload receipt{% endif %}
            </label>
            <input type="file" name="receipt" id="id_receipt" accept="image/*,.pdf"
                   class="w-full px-4 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500">
            <p class="text-xs text-primary-500 mt-1">Accepted formats: Images (JPG, PNG) or PDF</p>
        </div>
    </div>

    <!-- Submit -->
    <div class="flex justify-between items-center">
        <a href="{% url 'finance:expense_list' %}" class="text-primary-600 hover:text-primary-700">
            Cancel
        </a>
        {% if expense %}
        <div class="flex gap-4">
            <a href="{% url 'finance:expense_delete' expense.pk %}" class="text-red-600 hover:text-red-700">
                Delete
            </a>
            <button type="submit" class="px-6 py-3 bg-accent-500 hover:bg-accent-600 text-white font-semibold rounded-lg transition-colors">
                Save Changes
            </button>
        </div>
        {% else %}
        <button type="submit" class="px-6 py-3 bg-accent-500 hover:bg-accent-600 text-white font-semibold rounded-lg transition-colors">
            Create Expense
        </button>
        {% endif %}
    </div>
</form>
{% endblock %}
