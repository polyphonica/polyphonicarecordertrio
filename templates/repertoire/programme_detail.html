{% extends 'staff/base.html' %}

{% block title %}{{ programme.title }} - Polyphonica{% endblock %}

{% block staff_title %}{{ programme.title }}{% endblock %}
{% block staff_subtitle %}
<span class="px-2 py-1 text-xs font-medium rounded-full {% if programme.status == 'final' %}bg-green-100 text-green-700{% else %}bg-yellow-100 text-yellow-700{% endif %}">
    {{ programme.get_status_display }}
</span>
{% endblock %}

{% block staff_actions %}
<div class="flex gap-2">
    <a href="{% url 'repertoire:programme_pdf_performer' programme.pk %}" class="px-4 py-2 bg-primary-100 hover:bg-primary-200 text-primary-700 rounded-lg font-medium transition-colors">
        Performer PDF
    </a>
    <a href="{% url 'repertoire:programme_pdf_public' programme.pk %}" class="px-4 py-2 bg-primary-100 hover:bg-primary-200 text-primary-700 rounded-lg font-medium transition-colors">
        Public PDF
    </a>
    <a href="{% url 'repertoire:programme_edit' programme.pk %}" class="px-4 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg font-medium transition-colors">
        Edit Details
    </a>
</div>
{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %}

{% block staff_content %}
<div class="grid lg:grid-cols-3 gap-6">
    <!-- Programme Items (2/3) -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-sm">
            <div class="px-6 py-4 border-b border-primary-100 flex justify-between items-center">
                <h2 class="font-semibold text-primary-900">Programme Items</h2>
                <div class="text-sm text-primary-600">
                    Total: <span id="total-duration" class="font-semibold">{{ programme.total_duration_display }}</span>
                </div>
            </div>

            <div id="programme-items" class="divide-y divide-primary-100">
                {% for item in items %}
                <div class="programme-item flex items-center gap-4 px-6 py-4 hover:bg-primary-50 cursor-move" data-id="{{ item.id }}">
                    <div class="drag-handle text-primary-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                        </svg>
                    </div>

                    <div class="flex-1">
                        {% if item.item_type == 'piece' and item.piece %}
                            <div class="font-medium text-primary-900">{{ item.piece.title }}</div>
                            <div class="text-sm text-primary-600">{{ item.piece.composer.name }}{% if item.piece.catalogue_number %} &bull; {{ item.piece.catalogue_number }}{% endif %}</div>
                        {% elif item.item_type == 'interval' %}
                            <div class="font-medium text-primary-500 italic">— Interval —</div>
                        {% else %}
                            <div class="font-medium text-primary-900">{{ item.title|default:"Talk" }}</div>
                            <div class="text-sm text-primary-500">Talk</div>
                        {% endif %}
                    </div>

                    <div class="text-sm font-medium text-primary-600 w-16 text-right">
                        {{ item.duration_display }}
                    </div>

                    <div class="flex gap-2">
                        <a href="{% url 'repertoire:programme_item_edit' item.pk %}" class="text-accent-600 hover:text-accent-700 text-sm">Edit</a>
                        <button type="button" class="delete-item text-red-600 hover:text-red-700 text-sm" data-id="{{ item.id }}">Remove</button>
                    </div>
                </div>
                {% empty %}
                <div id="empty-message" class="p-12 text-center text-primary-500">
                    No items yet. Add pieces, talks, or intervals using the panel on the right.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Add Items Panel (1/3) -->
    <div class="space-y-6">
        <!-- Add Piece -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="font-semibold text-primary-900 mb-4">Add Piece</h3>
            <form id="add-piece-form" class="space-y-4">
                <div>
                    <select id="piece-select" name="piece_id" class="w-full px-3 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500">
                        <option value="">Select a piece...</option>
                        {% for piece in pieces %}
                        <option value="{{ piece.id }}" data-duration="{{ piece.duration_display }}">
                            {{ piece.title }} - {{ piece.composer.name }} ({{ piece.duration_display }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="w-full px-4 py-2 bg-accent-500 hover:bg-accent-600 text-white rounded-lg font-medium transition-colors">
                    Add to Programme
                </button>
            </form>
            <p class="mt-3 text-sm text-primary-500">
                <a href="{% url 'repertoire:piece_add' %}" class="text-accent-600 hover:text-accent-700">Add new piece to library</a>
            </p>
        </div>

        <!-- Add Talk -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="font-semibold text-primary-900 mb-4">Add Talk</h3>
            <form id="add-talk-form" class="space-y-4">
                <div>
                    <input type="text" name="title" placeholder="e.g., Introduction" class="w-full px-3 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500">
                </div>
                <div>
                    <input type="number" name="duration" placeholder="Duration (minutes)" class="w-full px-3 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500">
                </div>
                <div>
                    <textarea name="talk_text" rows="3" placeholder="Talk notes (optional)" class="w-full px-3 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500"></textarea>
                </div>
                <button type="submit" class="w-full px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition-colors">
                    Add Talk
                </button>
            </form>
        </div>

        <!-- Add Interval -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="font-semibold text-primary-900 mb-4">Add Interval</h3>
            <form id="add-interval-form" class="space-y-4">
                <div>
                    <input type="number" name="duration" placeholder="Duration (minutes)" value="15" class="w-full px-3 py-2 border border-primary-300 rounded-lg focus:ring-2 focus:ring-accent-500">
                </div>
                <button type="submit" class="w-full px-4 py-2 bg-primary-400 hover:bg-primary-500 text-white rounded-lg font-medium transition-colors">
                    Add Interval
                </button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const programmeId = {{ programme.pk }};
    const itemsContainer = document.getElementById('programme-items');
    const csrfToken = '{{ csrf_token }}';

    // Initialize SortableJS
    new Sortable(itemsContainer, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'bg-accent-100',
        onEnd: function() {
            saveOrder();
        }
    });

    function saveOrder() {
        const items = Array.from(itemsContainer.querySelectorAll('.programme-item'))
            .map(el => parseInt(el.dataset.id));

        fetch(`/manage/repertoire/programmes/${programmeId}/reorder/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ items: items })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-duration').textContent = data.total_duration;
            }
        });
    }

    function hideEmptyMessage() {
        const emptyMsg = document.getElementById('empty-message');
        if (emptyMsg) emptyMsg.remove();
    }

    function addItemToList(item) {
        hideEmptyMessage();

        const div = document.createElement('div');
        div.className = 'programme-item flex items-center gap-4 px-6 py-4 hover:bg-primary-50 cursor-move';
        div.dataset.id = item.id;

        let content = '';
        if (item.type === 'piece') {
            content = `<div class="font-medium text-primary-900">${item.title}</div>`;
        } else if (item.type === 'interval') {
            content = `<div class="font-medium text-primary-500 italic">— Interval —</div>`;
        } else {
            content = `<div class="font-medium text-primary-900">${item.title}</div><div class="text-sm text-primary-500">Talk</div>`;
        }

        div.innerHTML = `
            <div class="drag-handle text-primary-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                </svg>
            </div>
            <div class="flex-1">${content}</div>
            <div class="text-sm font-medium text-primary-600 w-16 text-right">${item.duration}</div>
            <div class="flex gap-2">
                <a href="/manage/repertoire/programme-items/${item.id}/edit/" class="text-accent-600 hover:text-accent-700 text-sm">Edit</a>
                <button type="button" class="delete-item text-red-600 hover:text-red-700 text-sm" data-id="${item.id}">Remove</button>
            </div>
        `;

        itemsContainer.appendChild(div);
        attachDeleteHandler(div.querySelector('.delete-item'));
    }

    // Add piece form
    document.getElementById('add-piece-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const pieceId = document.getElementById('piece-select').value;
        if (!pieceId) return;

        const formData = new FormData();
        formData.append('item_type', 'piece');
        formData.append('piece_id', pieceId);

        fetch(`/manage/repertoire/programmes/${programmeId}/add-item/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addItemToList(data.item);
                document.getElementById('piece-select').value = '';
                location.reload(); // Refresh to update duration
            }
        });
    });

    // Add talk form
    document.getElementById('add-talk-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('item_type', 'talk');
        formData.append('title', this.querySelector('[name="title"]').value);
        formData.append('duration', this.querySelector('[name="duration"]').value);
        formData.append('talk_text', this.querySelector('[name="talk_text"]').value);

        fetch(`/manage/repertoire/programmes/${programmeId}/add-item/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    });

    // Add interval form
    document.getElementById('add-interval-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('item_type', 'interval');
        formData.append('title', 'Interval');
        formData.append('duration', this.querySelector('[name="duration"]').value);

        fetch(`/manage/repertoire/programmes/${programmeId}/add-item/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    });

    // Delete handlers
    function attachDeleteHandler(btn) {
        btn.addEventListener('click', function() {
            if (!confirm('Remove this item from the programme?')) return;

            const itemId = this.dataset.id;
            fetch(`/manage/repertoire/programme-items/${itemId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.closest('.programme-item').remove();
                    document.getElementById('total-duration').textContent = data.total_duration;
                }
            });
        });
    }

    document.querySelectorAll('.delete-item').forEach(attachDeleteHandler);
});
</script>
{% endblock %}
